<!DOCTYPE html>
<html lang="en" id="html-root">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risky Weather: Model Comparison</title>
    
    <!-- Primary Meta Tags -->
    <meta name="title" content="Risky Weather: Model Comparison">
    <meta name="description" content="Learn probabilistic thinking and climate context by comparing weather forecast models. Explore model uncertainty, climate data, and educational lessons on weather vs risk.">
    <meta name="keywords" content="weather forecast, climate literacy, model comparison, uncertainty, probabilistic thinking, GEM, ECMWF, GFS, climate education">
    <meta name="author" content="Risky Weather Project">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://mgifford.github.io/risky-weather/">
    <meta property="og:title" content="Risky Weather: Model Comparison">
    <meta property="og:description" content="Learn probabilistic thinking and climate context by comparing weather forecast models. Explore model uncertainty, climate data, and educational lessons on weather vs risk.">
    <meta property="og:image" content="https://mgifford.github.io/risky-weather/icons/icon-512.png">
    <meta property="og:image:width" content="512">
    <meta property="og:image:height" content="512">
    <meta property="og:image:alt" content="Risky Weather application icon showing sun and cloud">
    <meta property="og:site_name" content="Risky Weather">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://mgifford.github.io/risky-weather/">
    <meta name="twitter:title" content="Risky Weather: Model Comparison">
    <meta name="twitter:description" content="Learn probabilistic thinking and climate context by comparing weather forecast models. Explore model uncertainty, climate data, and educational lessons.">
    <meta name="twitter:image" content="https://mgifford.github.io/risky-weather/icons/icon-512.png">
    <meta name="twitter:image:alt" content="Risky Weather application icon">
    
    <!-- LinkedIn-specific optimizations -->
    <meta property="article:author" content="Risky Weather Project">
    <meta property="article:tag" content="Climate Literacy">
    <meta property="article:tag" content="Weather Forecasting">
    <meta property="article:tag" content="Data Visualization">
    <meta property="article:tag" content="Educational Technology">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://mgifford.github.io/risky-weather/">
    
    <link rel="stylesheet" href="style.css">
    <!-- Use system font stack for performance and sustainability -->
</head>
<body>

    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><rect width='16' height='16' fill='%23ffffff'/><g fill='%23f6c358'><circle cx='5' cy='5' r='3'/></g><g fill='%23cfd8dc'><path d='M10 9c-1-1-3-1-4 0-1 1-1 3 0 4s3 1 4 0 1-3 0-4z'/></g></svg>" type="image/svg+xml">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="theme-color" content="#03a9f4">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="mask-icon" href="/icons/icon.svg" color="#03a9f4">
    <meta name="apple-mobile-web-app-title" content="Risky Weather">
    <header>
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div style="flex: 1;">
                <h1 data-i18n="ui.title">Risky <span style="color:var(--gem-color)">Weather</span></h1>
                <p class="subtitle" data-i18n="ui.subtitle">Comparing Models & Assessing Uncertainty</p>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
                <button id="language-toggle-btn" class="language-toggle" title="Toggle language" aria-label="Toggle language"></button>
                <div id="connection-indicator" class="connection-indicator" title="Click to check connection" aria-label="Connection status" role="button" tabindex="0" style="display: flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 4px; cursor: pointer; background: var(--card); border: 1px solid var(--border-color, #e0e0e0);">
                    <span class="connection-dot connected" style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: green; transition: background 0.3s;"></span>
                    <span class="connection-text" style="font-size: 0.8rem; color: var(--subtext);">Online</span>
                </div>
                <div id="theme-toggle" aria-label="Toggle theme" role="group" style="display:flex; gap:6px; align-items:center;">
                    <button id="btn-light" class="theme-btn" title="Light mode" aria-label="Light mode" onclick="(function(){ document.body.classList.remove('dark-theme'); document.documentElement.removeAttribute('data-theme'); localStorage.setItem('preferred-theme','light'); document.getElementById('btn-light')?.setAttribute('aria-pressed','true'); document.getElementById('btn-dark')?.setAttribute('aria-pressed','false'); })()">â˜€ï¸</button>
                    <button id="btn-dark" class="theme-btn" title="Dark mode" aria-label="Dark mode" onclick="(function(){ document.body.classList.add('dark-theme'); document.documentElement.setAttribute('data-theme','dark'); localStorage.setItem('preferred-theme','dark'); document.getElementById('btn-dark')?.setAttribute('aria-pressed','true'); document.getElementById('btn-light')?.setAttribute('aria-pressed','false'); })()">ğŸŒ™</button>
                </div>
            </div>
        </div>
        
        <!-- City Search and Location on same line -->
        <div style="width: 100%; max-width: min(95%, 600px); margin: 12px auto;">
            <label for="city-search-input" style="display: block; margin-bottom: 6px; font-size: 0.9rem; font-weight: 500; color: var(--text);">Search for a city</label>
            <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center; position: relative;">
                <input 
                    type="text" 
                    id="city-search-input" 
                    placeholder="Search for a city..."
                    data-i18n-placeholder="ui.searchCity"
                    role="combobox" aria-autocomplete="list" aria-controls="city-search-results" aria-expanded="false"
                    style="flex: 1; min-width: 180px; padding: 8px 32px 8px 10px; border: 2px solid color-mix(in srgb, var(--card) 80%, transparent); border-radius: 6px; font-size: 0.9rem;"
                />
                <span style="position: absolute; left: auto; right: auto; color: var(--subtext); pointer-events: none; margin-left: 8px;">ğŸ”</span>
                <ul id="city-search-results" role="listbox" aria-live="polite" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: var(--card); border: 2px solid color-mix(in srgb, var(--card) 80%, transparent); border-top: none; border-radius: 0 0 6px 6px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></ul>
                
                <div class="location-badge" id="location-display" style="font-size: 0.85rem; padding: 6px 10px; border-radius: 4px; background: color-mix(in srgb, var(--card) 50%, transparent); border: 1px solid var(--border-color, #e0e0e0); text-align: right; flex: 0 1 auto; word-break: break-word;">â€”</div>
            </div>
        </div>
        
        <div class="debug-info">
            <div class="debug-info-line">
                <span class="debug-label">IP:</span> <span id="ip-display">â€”</span>
            </div>
            <div class="debug-info-line">
                <span class="debug-label">Storage:</span> <span id="storage-display">â€”</span>
            </div>
        </div>
    </header>

    <main>
        
        <section id="current-conditions" class="card hidden">
            <div class="card-title">
                <h2 style="margin:0; font-size:1.1rem;">ğŸŒ¡ï¸ <span data-i18n="ui.currentConditions">Current Conditions</span></h2>
                <span style="font-size: 0.85rem; color: var(--subtext);" id="current-time">--</span>
            </div>
            <div style="text-align: center; padding: 20px;">
                <!-- Weather Alerts Section (Canada Only) -->
                <div id="weather-alerts" style="display: none; background: #fff3cd; border: 2px solid #ffc107; border-radius: 6px; padding: 12px; margin: 0 0 16px 0; text-align: left;">
                    <div style="font-weight: 600; color: #856404; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 1.3rem;">âš ï¸</span>
                        <span>Active Weather Alerts</span>
                    </div>
                    <div id="alerts-content" style="color: #856404; font-size: 0.9rem; line-height: 1.5;"></div>
                </div>

                <div class="current-weather" style="display: inline-block;">
                    <div class="current-icon" id="current-icon">â˜ï¸</div>
                    <div class="current-temp" id="current-temp">--Â°</div>
                </div>
                <div class="current-desc" id="current-desc" style="margin: 12px 0;">--</div>
                <div class="current-details" id="current-details" style="max-width: 400px; margin: 0 auto;"></div>
                <div style="font-size: 0.75rem; color: var(--subtext); margin-top: 16px;">
                    <a href="https://open-meteo.com/" target="_blank" rel="noopener" style="color: inherit; text-decoration: underline;">Data: Open-Meteo</a>
                </div>
            </div>
        </section>

        <section id="scoreboard-section" class="card hidden">
            <div class="card-title">
                <h2 style="margin:0; font-size:1.1rem;" data-i18n="ui.scoreboard">ğŸ† Model Scoreboard</h2>
                <span style="font-size:0.75rem; font-weight:400; color:var(--subtext);"><span data-i18n="ui.winsSince">Wins since</span> <span id="start-date">--</span></span>
            </div>
            <div class="scoreboard">
                <div class="score-box">
                    <div class="score-val" id="score-a">0</div>
                    <div class="score-label" id="score-label-a">Model A</div>
                </div>
                <div style="align-self:center; color:var(--subtext); font-weight:900;" data-i18n="ui.versus">vs</div>
                <div class="score-box">
                    <div class="score-val" id="score-b">0</div>
                    <div class="score-label" id="score-label-b">Model B</div>
                </div>
            </div>
        </section>

        <section id="reality-check" class="card hidden">
            <div class="card-title"><h2 style="margin:0; font-size:1.1rem;" data-i18n="ui.yesterday">ğŸ” Yesterday's Result</h2></div>
            <div id="reality-content" style="font-size: 0.95rem; line-height: 1.6;"></div>
            <div id="winner-display"></div>
        </section>

        <!-- Scenario Badge (appears when in test mode) -->
        <div id="scenario-badge" style="display: none; background: color-mix(in srgb, #FF9800 15%, transparent); border: 2px solid #FF9800; border-radius: 8px; padding: 12px; margin: 16px 0; color: var(--text); font-size: 0.9rem; justify-content: space-between; align-items: center;"></div>

        <!-- Actions Panel -->
        <section id="actions-section" class="card hidden">
            <div class="card-title">
                <h2 style="margin:0; font-size:1.1rem;">âš¡ Actions</h2>
                <span style="font-size: 0.85rem; color: var(--subtext);">What to do today</span>
            </div>
            <div id="actions-content"></div>
        </section>

        <!-- Debug Section (only shown when debug=1) -->
        <section id="debug-section" style="display: none; background: color-mix(in srgb, var(--card) 80%, transparent); border: 1px solid color-mix(in srgb, var(--card) 60%, transparent); border-radius: 8px; padding: 16px; margin: 16px 0; font-family: monospace; font-size: 0.85rem;"></section>

        <section class="card" id="todays-forecast">
            <div class="card-title">
                <a href="#todays-forecast" style="text-decoration: none; color: inherit;">
                    <h2 style="margin:0;" data-i18n="ui.today">ğŸ“Š Today's Forecast</h2>
                </a>
                <span style="font-size: 0.85rem; color: var(--subtext);" data-i18n="ui.highTemp">High Temp</span>
            </div>

            <div class="model-battle">
                <div class="model-col" id="col-a" style="color: var(--gem-color);">
                    <h3 id="label-model-a">Loading...</h3>
                    <div class="model-val" id="val-model-a">--Â°</div>
                    <div class="model-rain" id="rain-model-a">--% Chance of precipitation</div>
                </div>

                <div class="divider"></div>

                <div class="model-col" id="col-b" style="color: var(--euro-color);">
                    <h3 id="label-model-b">Loading...</h3>
                    <div class="model-val" id="val-model-b">--Â°</div>
                    <div class="model-rain" id="rain-model-b">--% Chance</div>
                </div>
            </div>

            <a id="link-primary" href="#" target="_blank" class="official-link hidden">View Official Environment Canada Report &rarr;</a>
        </section>

        <section class="card" id="seven-day">
            <div class="card-title">
                <a href="#seven-day" style="text-decoration: none; color: inherit;">
                    <h2 style="margin:0;" data-i18n="ui.sevenDay">ğŸ“… 7-Day Competition</h2>
                </a>
            </div>
            <table class="forecast-table">
                <thead>
                    <tr>
                        <th class="col-day">Day</th>
                        <th class="col-model" id="head-model-a">Model A</th>
                        <th class="col-model" id="head-model-b">Model B</th>
                    </tr>
                </thead>
                <tbody id="forecast-list">
                    <tr><td colspan="3" style="text-align:center; padding:20px;">Waiting for Location...</td></tr>
                </tbody>
            </table>
            <div style="margin-top: 16px;">
                <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 8px; color: var(--text);" data-i18n="rain.legendTitle">Chance of precipitation</div>
                <div class="rain-legend">
                    <div class="rain-legend-item">
                        <span class="rain-legend-pill rain-none">0-29%</span>
                        <span data-i18n="rain.lowRisk">Unlikely</span>
                    </div>
                    <div class="rain-legend-item">
                        <span class="rain-legend-pill rain-low">30-59%</span>
                        <span data-i18n="rain.moderateRisk">Possible</span>
                    </div>
                    <div class="rain-legend-item">
                        <span class="rain-legend-pill rain-med">60-79%</span>
                        <span data-i18n="rain.highRisk">Likely</span>
                    </div>
                    <div class="rain-legend-item">
                        <span class="rain-legend-pill rain-high">80-100%</span>
                        <span data-i18n="rain.veryHighRisk">Very Likely</span>
                    </div>
                </div>
            </div>
            
            <!-- Model Disagreement - moved inside 7-day section -->
            <div style="margin-top: 24px; border-top: 1px solid var(--border-color, #e0e0e0); padding-top: 16px;">
                <details>
                    <summary style="cursor: pointer; font-weight: 600; font-size: 1rem; padding: 8px 0; list-style-position: outside;">ğŸ¯ Understanding Model Disagreement</summary>
                    <div style="margin-top:6px; font-size:0.85rem;">
                        <a href="#seven-day" style="text-decoration: none; color: inherit; display:inline-block;">Back to top</a>
                    </div>
                    <div style="margin-top: 12px;">
                        <p style="margin: 0;" data-i18n="ui.uncertaintyDescription">When models disagree significantly, forecast uncertainty is <strong>high</strong>. Look for ğŸ¤” (high uncertainty) or ğŸ”€ (moderate uncertainty) icons next to days below.</p>
                        <p style="margin: 8px 0 0 0; font-size: 0.85rem; color: var(--subtext);">
                            â€¢ <strong>Temperature difference &gt;5Â°C:</strong> Plan for a wide range<br>
                            â€¢ <strong>Rain difference &gt;30%:</strong> One model sees rain, another doesn't<br>
                            â€¢ <strong>Models agree closely:</strong> High confidence forecast
                        </p>
                    </div>
                </details>
            </div>
        </section>

        <section id="historical-normals-section" class="card hidden">
            <div class="card-title"><h2 style="margin:0; font-size:1.1rem;">ğŸ“ˆ <span data-i18n="ui.historicalNormals">Historical Averages (Last 10 Years)</span></h2></div>
            <div id="historical-normals-summary" style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 12px;"></div>
            <details>
                <summary style="cursor: pointer; font-weight: 600; font-size: 0.95rem; padding: 8px 0; list-style-position: outside;">
                    <span data-i18n="ui.moreDetails">More Details</span>
                </summary>
                <div id="historical-normals-content" style="font-size: 0.9rem; line-height: 1.6; margin-top: 12px;"></div>
            </details>
        </section>

        <!-- Battle History Section -->
        <section id="battle-history-section" class="card" style="display: none;">
            <div class="card-title">
                <a href="#weather-model-battles" style="text-decoration: none; color: inherit;" id="weather-model-battles">
                    <span>âš”ï¸ Weather Model Battles</span>
                </a>
            </div>
            <!-- Content will be dynamically generated -->
        </section>

        <section id="history-section" class="card hidden">
            <div class="card-title">
                <a href="#climate-history" style="text-decoration: none; color: inherit;" id="climate-history">
                    <span data-i18n="ui.historyTitle">ğŸ“œ On This Day in Climate History</span>
                </a>
            </div>
            <div id="history-content" style="font-size: 0.9rem; color: var(--text);"></div>
        </section>

        <!-- Random Sections Container -->
        <div id="random-sections"></div>

        <div style="text-align: center; margin: 20px 0;">
            <button id="reset-btn" class="secondary-btn" data-i18n="ui.resetLocation">Reset Location & History</button>
            <button id="refresh-location-btn" class="secondary-btn" data-i18n="ui.refreshLocation" style="margin-left: 10px;">ğŸ”„ Refresh Location</button>
            <button id="view-cache-btn" class="secondary-btn" data-i18n="ui.viewCache" style="margin-left: 10px;">ğŸ“‹ View Cache</button>
            <div style="position: relative; display: inline-block; margin-left: 10px;">
                <button id="share-btn" class="secondary-btn" data-i18n="ui.shareLocation" aria-haspopup="menu" aria-expanded="false">ğŸ”— Share</button>
                <div id="share-menu" role="menu" style="display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: var(--card); border: 1px solid var(--border-color, #e0e0e0); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px; margin-bottom: 8px; z-index: 1000; overflow: hidden;">
                    <button id="share-copy-btn" role="menuitem" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 0.9rem; color: var(--text); transition: background 0.2s;" onmouseover="this.style.background='color-mix(in srgb, var(--card) 70%, transparent)'" onmouseout="this.style.background='none'">ğŸ“‹ Copy Link</button>
                    <button id="share-linkedin-btn" role="menuitem" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 0.9rem; color: var(--text); transition: background 0.2s;" onmouseover="this.style.background='color-mix(in srgb, var(--card) 70%, transparent)'" onmouseout="this.style.background='none'">ğŸ’¼ Share on LinkedIn</button>
                    <button id="share-mastodon-btn" role="menuitem" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 0.9rem; color: var(--text); transition: background 0.2s;" onmouseover="this.style.background='color-mix(in srgb, var(--card) 70%, transparent)'" onmouseout="this.style.background='none'">ğŸ˜ Share on Mastodon</button>
                    <button id="share-bluesky-btn" role="menuitem" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 0.9rem; color: var(--text); transition: background 0.2s;" onmouseover="this.style.background='color-mix(in srgb, var(--card) 70%, transparent)'" onmouseout="this.style.background='none'">â˜ï¸ Share on Bluesky</button>
                </div>
            </div>
        </div>
    
        <footer style="text-align: center; margin: 40px 0 20px; padding: 20px 0; border-top: 1px solid color-mix(in srgb, var(--card) 80%, transparent);">
            <p style="font-size: 0.85rem; color: var(--subtext); margin: 0 0 8px 0;">
                <strong style="color:var(--text);">Data Sources:</strong> 
                <a href="https://open-meteo.com/" target="_blank" rel="noopener" style="color: inherit; text-decoration: underline;">Open-Meteo API</a> â€¢ 
                <a href="https://ipwho.is/" target="_blank" rel="noopener" style="color: inherit; text-decoration: underline;">IPWho.is</a>
            </p>
            <p style="font-size: 0.85rem; color: var(--subtext); margin: 8px 0 0 0;">
                <a href="https://github.com/mgifford/risky-weather" target="_blank" rel="noopener" style="color: inherit; text-decoration: underline;">
                    <svg style="width: 16px; height: 16px; vertical-align: middle; margin-right: 4px;" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                    </svg>
                    View on GitHub
                </a>
            </p>

            <!-- Bluesky Footer -->
<meta data-bsky-post-id="33m7scihdvzc2l" />
<section class="post__likes" data-bsky-container>
  <h3 class="post__likesTitle">
    ğŸ¦‹ <span data-bsky-likes-count></span> likes on Bluesky
  </h3>
  <a class="post__likesCta" href="https://bsky.app/profile/ox.ca/post/3m7scihdvzc2l" target="_blank">
	  Like this post on Bluesky to see your face on this page
  </a>
  <ul data-bsky-likes class="post__likesList"></ul>
</section>

            
        </footer>
    </main>

    <!-- Cache Inspector Modal -->
    <div id="cache-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow: auto;">
            <div role="dialog" aria-modal="true" aria-labelledby="cache-modal-title" style="background: var(--card); max-width: 700px; margin: 50px auto; padding: 30px; border-radius: 12px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="cache-modal-title" style="margin: 0; font-size: 1.3rem;">ğŸ“‹ Cache Inspector</h2>
                <button id="close-cache-btn" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">âœ•</button>
            </div>
            <div id="cache-content" style="font-family: monospace; font-size: 0.85rem; line-height: 1.6; color: var(--text);">
                Loading cache...
            </div>
        </div>
    </div>
    
    <div id="status-log" role="status" aria-live="polite">Status: Init</div>
    <div id="sr-announcer" class="sr-only" aria-live="polite" aria-atomic="true"></div>
    <style>
        /* Prevent focus being obscured by status log */
        body { padding-bottom: 28px; }
    </style>

    <!-- Module Scripts (load in dependency order) -->
    <script src="modules/i18n.js"></script>
    <script src="modules/storage.js"></script>
    <script src="modules/calculations.js"></script>
    <script src="modules/api.js"></script>
    <script src="modules/battles.js"></script>
    <script src="modules/ui.js"></script>
    <script src="modules/geo.js"></script>
    <script src="modules/history.js"></script>
    <script src="modules/climate_data.js"></script>
    <script src="modules/scenario.js"></script>
    <script src="modules/actions.js"></script>
    <script src="modules/connection.js"></script>
    <script src="modules/app.js"></script>

    <!-- Application Entry Point -->
    <script>
        // Initialize application when DOM is ready
        UI.onReset(() => {
            App.reset();
        });

        UI.onRefreshLocation(() => {
            App.refreshLocation();
        });

        UI.onCacheInspector(() => {
            console.log('Cache Inspector opened');
        });

        // Theme: initialize and bind toggle buttons here so theme works even
        // if separate script files aren't loaded.
        (function(){
            const root = document.documentElement;
            function applyTheme(theme){
                if(theme === 'dark'){
                    root.setAttribute('data-theme','dark');
                    document.body.classList.add('dark-theme');
                    document.getElementById('btn-dark')?.setAttribute('aria-pressed','true');
                    document.getElementById('btn-light')?.setAttribute('aria-pressed','false');
                    const __btn_light = document.getElementById('btn-light');
                    if (__btn_light) __btn_light.style.display = 'inline-block';
                    document.getElementById('btn-light')?.setAttribute('aria-label','Switch to light mode');
                    const __btn_dark = document.getElementById('btn-dark');
                    if (__btn_dark) __btn_dark.style.display = 'none';
                } else {
                    root.removeAttribute('data-theme');
                    document.body.classList.remove('dark-theme');
                    document.getElementById('btn-light')?.setAttribute('aria-pressed','true');
                    document.getElementById('btn-dark')?.setAttribute('aria-pressed','false');
                    const __btn_dark = document.getElementById('btn-dark');
                    if (__btn_dark) __btn_dark.style.display = 'inline-block';
                    document.getElementById('btn-dark')?.setAttribute('aria-label','Switch to dark mode');
                    const __btn_light = document.getElementById('btn-light');
                    if (__btn_light) __btn_light.style.display = 'none';
                }
            }

            function initTheme(){
                const saved = localStorage.getItem('preferred-theme');
                if(saved === 'dark' || saved === 'light'){
                    applyTheme(saved);
                    return;
                }
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(prefersDark ? 'dark' : 'light');
                window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                    const stillSaved = localStorage.getItem('preferred-theme');
                    if(!stillSaved) applyTheme(e.matches ? 'dark' : 'light');
                });
            }

            // Run immediately (buttons exist before this script) and also
            // keep the listener for completeness.
            try { initTheme(); } catch(e) { console.warn('initTheme failed', e); }
            const btnLight = document.getElementById('btn-light');
            const btnDark = document.getElementById('btn-dark');
            if (btnLight) btnLight.addEventListener('click', () => { applyTheme('light'); localStorage.setItem('preferred-theme','light'); });
            if (btnDark) btnDark.addEventListener('click', () => { applyTheme('dark'); localStorage.setItem('preferred-theme','dark'); });
            document.addEventListener('DOMContentLoaded', () => {
                initTheme();
            });
        })();

        App.init();
    </script>
        <script>
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/service-worker.js').then(reg => {
                        console.log('ServiceWorker registered', reg.scope);
                    }).catch(err => console.warn('ServiceWorker registration failed', err));
                });
            }
        </script>
</body>
</html>
