<!DOCTYPE html>
<html lang="en" id="html-root">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risky Weather: Model Comparison</title>
    <!-- Use system font stack for performance and sustainability -->
    <style>
        :root {
            --bg: #f4f6f8;
            --card: #ffffff;
            --text: #2d3748;
            --subtext: #718096;
            --highlight: #3182ce;
            --accent: #e53e3e;
            --gem-color: #c53030; /* Canadian Red */
            --euro-color: #2b6cb0; /* Euro Blue */
            --gfs-color: #805ad5; /* US Purple */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, Cantarell, "Noto Sans", "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.5;
        }

        /* HEADER */
        header { text-align: center; margin-bottom: 25px; width: 100%; max-width: 600px; }
        h1 { margin: 0; font-weight: 800; letter-spacing: -1px; font-size: 1.8rem; }
        .subtitle { color: var(--subtext); font-size: 0.9em; margin-top: 5px; }

        .language-toggle {
            background: none;
            border: 1px solid #cbd5e0;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            color: var(--text);
            transition: all 0.2s;
            min-width: 50px;
        }
        .language-toggle:hover {
            background: #edf2f7;
            border-color: #a0aec0;
        }

        .location-badge {
            background: #e2e8f0;
            padding: 6px 16px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            color: #2d3748;
            border: 1px solid #cbd5e0;
        }

        /* CARDS */
        .card {
            background: var(--card);
            width: 100%;
            max-width: 550px;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            margin-bottom: 24px;
        }

        .card-title {
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #edf2f7;
            padding-bottom: 12px;
            font-size: 1.1rem;
        }

        /* TODAY'S BATTLE */
        .model-battle {
            display: grid;
            grid-template-columns: 1fr 1px 1fr;
            gap: 10px;
            text-align: center;
        }
        .divider { width: 1px; background: #e2e8f0; height: 100%; }
        
        .model-col h3 { font-size: 0.75rem; text-transform: uppercase; margin-bottom: 5px; color: var(--subtext); letter-spacing: 0.5px; }
        .model-val { font-size: 2.5rem; font-weight: 800; line-height: 1; }
        .model-rain { font-size: 0.9rem; font-weight: 600; margin-top: 8px; color: var(--highlight); }
        
        /* 7-DAY TABLE */
        .forecast-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .forecast-table th { text-align: left; color: var(--subtext); padding: 8px 4px; border-bottom: 2px solid #edf2f7; font-size: 0.8rem; text-transform: uppercase;}
        .forecast-table td { padding: 10px 4px; border-bottom: 1px solid #f7fafc; vertical-align: middle; }
        .col-day { width: 15%; font-weight: 600; color: #4a5568; }
        .col-model { width: 42%; }

        .temp-val { font-weight: 700; color: #2d3748; margin-left: 6px; }
        .rain-pill {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.75rem;
            min-width: 35px;
            text-align: center;
        }
        .rain-none { background: #f7fafc; color: #718096; font-weight: 600; }
        .rain-low { background: #ebf8ff; color: #2b6cb0; }
        .rain-med { background: #bee3f8; color: #2c5282; }
        .rain-high { background: #fed7d7; color: #c53030; }

        /* LINKS */
        .official-link {
            display: block;
            text-align: center;
            margin-top: 15px;
            font-size: 0.9rem;
            color: #fff;
            background-color: var(--gem-color);
            text-decoration: none;
            font-weight: 600;
            border: 1px solid var(--gem-color);
            padding: 10px;
            border-radius: 8px;
            transition: opacity 0.2s;
        }
        .official-link:hover { opacity: 0.9; }
        /* Accessible focus styles */
        a:focus, button:focus, .official-link:focus, .secondary-btn:focus, input:focus {
            outline: 3px solid #3182ce;
            outline-offset: 2px;
        }

        /* REALITY CHECK */
        .winner-banner {
            background: #c6f6d5;
            color: #22543d;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 700;
            margin-top: 10px;
            border: 1px solid #9ae6b4;
        }

        /* SCOREBOARD */
        .scoreboard {
            display: flex;
            justify-content: space-around;
            background: #2d3748;
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .score-box { text-align: center; }
        .score-val { font-size: 1.8rem; font-weight: 800; }
        .score-label { font-size: 0.75rem; opacity: 0.8; text-transform: uppercase; }

        /* STRIPES */
        .stripes-wrap { height: 40px; display: flex; width: 100%; border-radius: 6px; overflow: hidden; margin: 10px 0; }
        .stripe { flex: 1; height: 100%; }
        .legend { display: flex; justify-content: space-between; font-size: 0.75rem; color: #a0aec0; }

        .hidden { display: none; }
        .secondary-btn {
            background: none;
            border: none;
            color: #a0aec0;
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.85rem;
            margin-top: 20px;
        }

        /* STATUS LOG (Debug) */
        #status-log {
            position: fixed;
            bottom: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: #fff;
            font-size: 0.7rem;
            padding: 4px 8px;
            font-family: monospace;
            z-index: 999;
        }

        /* DEBUG INFO */
        .debug-info {
            font-size: 0.75rem;
            color: #718096;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #edf2f7;
            text-align: center;
        }
        .debug-info-line {
            margin: 2px 0;
        }
        .debug-label {
            font-weight: 600;
            color: #4a5568;
        }

        /* UNCERTAINTY INDICATORS */
        .uncertainty-badge {
            display: inline-block;
            font-size: 1rem;
            margin-left: 4px;
            vertical-align: middle;
        }

        .info-box {
            background: #edf2f7;
            border-left: 4px solid #3182ce;
            padding: 12px 16px;
            margin: 16px 0;
            border-radius: 6px;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .info-box-warning {
            background: #fffaf0;
            border-left-color: #ed8936;
        }

        .info-box-title {
            font-weight: 700;
            margin-bottom: 6px;
            color: #2d3748;
        }

        /* RAIN PROBABILITY LEGEND */
        .rain-legend {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            font-size: 0.8rem;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #edf2f7;
            justify-content: center;
        }
        .rain-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .rain-legend-pill {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.7rem;
            min-width: 30px;
            text-align: center;
        }
    </style>
</head>
<body>

    <header>
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div style="flex: 1;">
                <h1 data-i18n="ui.title">Risky <span style="color:var(--gem-color)">Weather</span></h1>
                <p class="subtitle" data-i18n="ui.subtitle">Comparing Models & Assessing Uncertainty</p>
            </div>
            <button id="language-toggle-btn" class="language-toggle" title="Toggle language"></button>
        </div>
        <div class="location-badge" id="location-display">Initializing...</div>
        
        <!-- City Search -->
        <div style="margin: 15px auto; max-width: 50%; position: relative;">
            <input 
                type="text" 
                id="city-search-input" 
                placeholder="Search for a city..."
                data-i18n-placeholder="ui.searchCity"
                role="combobox" aria-autocomplete="list" aria-controls="city-search-results" aria-expanded="false"
                style="width: 100%; padding: 10px 40px 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem;"
            />
            <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #a0aec0; pointer-events: none;">üîç</span>
            <ul id="city-search-results" role="listbox" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #e2e8f0; border-top: none; border-radius: 0 0 8px 8px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></ul>
        </div>
        
        <div class="debug-info">
            <div class="debug-info-line">
                <span class="debug-label">IP:</span> <span id="ip-display">‚Äî</span>
            </div>
            <div class="debug-info-line">
                <span class="debug-label">Storage:</span> <span id="storage-display">‚Äî</span>
            </div>
        </div>
    </header>

    <main>
        
        <section id="scoreboard-section" class="card hidden">
            <div class="card-title">
                <span data-i18n="ui.scoreboard">üèÜ Model Scoreboard</span>
                <span style="font-size:0.75rem; font-weight:400; color:#718096;"><span data-i18n="ui.winsSince">Wins since</span> <span id="start-date">--</span></span>
            </div>
            <div class="scoreboard">
                <div class="score-box">
                    <div class="score-val" id="score-a">0</div>
                    <div class="score-label" id="score-label-a">Model A</div>
                </div>
                <div style="align-self:center; color:#718096; font-weight:900;" data-i18n="ui.versus">vs</div>
                <div class="score-box">
                    <div class="score-val" id="score-b">0</div>
                    <div class="score-label" id="score-label-b">Model B</div>
                </div>
            </div>
        </section>

        <section id="reality-check" class="card hidden">
            <div class="card-title"><span data-i18n="ui.yesterday">üîç Yesterday's Result</span></div>
            <div id="reality-content" style="font-size: 0.95rem; line-height: 1.6;"></div>
            <div id="winner-display"></div>
        </section>

        <section class="card">
            <div class="card-title">
                <span data-i18n="ui.today">üìä Today's Forecast</span>
                <span style="font-size: 0.8rem; color: #a0aec0;" data-i18n="ui.highTemp">High Temp</span>
            </div>

            <div class="model-battle">
                <div class="model-col" id="col-a" style="color: var(--gem-color);">
                    <h3 id="label-model-a">Loading...</h3>
                    <div class="model-val" id="val-model-a">--¬∞</div>
                    <div class="model-rain" id="rain-model-a">--% Risk</div>
                </div>

                <div class="divider"></div>

                <div class="model-col" id="col-b" style="color: var(--euro-color);">
                    <h3 id="label-model-b">Loading...</h3>
                    <div class="model-val" id="val-model-b">--¬∞</div>
                    <div class="model-rain" id="rain-model-b">--% Risk</div>
                </div>
            </div>

            <a id="link-primary" href="#" target="_blank" class="official-link hidden">View Official Environment Canada Report &rarr;</a>
        </section>

        <section class="card">
            <div class="card-title">
                <span data-i18n="ui.sevenDay">üìÖ 7-Day Competition</span>
            </div>
            <table class="forecast-table">
                <thead>
                    <tr>
                        <th class="col-day">Day</th>
                        <th class="col-model" id="head-model-a">Model A</th>
                        <th class="col-model" id="head-model-b">Model B</th>
                    </tr>
                </thead>
                <tbody id="forecast-list">
                    <tr><td colspan="3" style="text-align:center; padding:20px;">Waiting for Location...</td></tr>
                </tbody>
            </table>
            <div style="margin-top: 16px;">
                <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 8px; color: #2d3748;" data-i18n="rain.legendTitle">Precipitation Risk</div>
                <div class="rain-legend">
                    <div class="rain-legend-item">
                        <span class="rain-legend-pill rain-none">0-29%</span>
                        <span data-i18n="rain.lowRisk">Unlikely</span>
                    </div>
                    <div class="rain-legend-item">
                        <span class="rain-legend-pill rain-low">30-59%</span>
                        <span data-i18n="rain.moderateRisk">Possible</span>
                    </div>
                    <div class="rain-legend-item">
                        <span class="rain-legend-pill rain-med">60-79%</span>
                        <span data-i18n="rain.highRisk">Likely</span>
                    </div>
                    <div class="rain-legend-item">
                        <span class="rain-legend-pill rain-high">80-100%</span>
                        <span data-i18n="rain.veryHighRisk">Very Likely</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="card">
            <details>
                <summary style="cursor: pointer; font-weight: 600; font-size: 1rem; padding: 8px 0; list-style-position: outside;">
                    <span data-i18n="ui.uncertaintyTitle">üéØ Understanding Model Disagreement</span>
                </summary>
                <div style="margin-top: 12px;">
                    <p style="margin: 0;" data-i18n="ui.uncertaintyDescription">When models disagree significantly, forecast uncertainty is <strong>high</strong>. Look for ü§î (high uncertainty) or üîÄ (moderate uncertainty) icons next to days below.</p>
                    <p style="margin: 8px 0 0 0; font-size: 0.85rem; color: #555;">
                        ‚Ä¢ <strong>Temperature difference &gt;5¬∞C:</strong> Plan for a wide range<br>
                        ‚Ä¢ <strong>Rain difference &gt;30%:</strong> One model sees rain, another doesn't<br>
                        ‚Ä¢ <strong>Models agree closely:</strong> High confidence forecast
                    </p>
                </div>
            </details>
        </section>

        <section id="historical-normals-section" class="card hidden">
            <div class="card-title">
                <span data-i18n="ui.historicalNormals">üìà Historical Averages (Last 10 Years)</span>
            </div>
            <div id="historical-normals-content" style="font-size: 0.9rem; line-height: 1.6;"></div>
        </section>

        <section id="history-section" class="card hidden">
            <div class="card-title">
                <span data-i18n="ui.historyTitle">üìú On This Day in Climate History</span>
            </div>
            <div id="history-content" style="font-size: 0.9rem; color: #2d3748;"></div>
        </section>

        <section class="card">
            <div class="card-title">
                <span id="lesson-icon">üí°</span>
                <span id="lesson-title" style="flex: 1; margin-left: 10px;" data-i18n="ui.education">Understanding Weather & Risk</span>
                <button id="lesson-cycle-btn" style="background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 0;" data-i18n-title="education.nextLesson" title="Show next lesson">‚Üí</button>
            </div>
            <p id="lesson-content" style="font-size: 0.95rem; color: #444; line-height: 1.6; margin: 0;" data-i18n="ui.loadingLesson">Loading lesson...</p>
            <div style="font-size: 0.75rem; color: #a0aec0; margin-top: 12px; text-align: right;">
                <span id="lesson-counter">1 / 20</span>
            </div>
        </section>

        <section class="card">
            <div class="card-title"><span data-i18n="ui.climateContext">üåç Climate Context</span></div>
            <p style="font-size: 0.85rem; color: #555;" data-i18n="stripes.description">Annual temperature deviation (1950-2023). <br><strong>Blue</strong> = Cooler than normal. <strong>Red</strong> = Warmer.</p>
            <div id="stripes" class="stripes-wrap"></div>
            <div class="legend"><span data-i18n="stripes.start">1950</span><span data-i18n="stripes.end">2023</span></div>
            <button id="load-stripes-btn" class="secondary-btn" style="margin-top: 10px;">Load Stripes</button>
        </section>

        <button id="reset-btn" class="secondary-btn" data-i18n="ui.resetLocation">Reset Location & History</button>
        <button id="refresh-location-btn" class="secondary-btn" data-i18n="ui.refreshLocation" style="margin-left: 10px;">üîÑ Refresh Location</button>
        <button id="view-cache-btn" class="secondary-btn" data-i18n="ui.viewCache" style="margin-left: 10px;">üìã View Cache</button>
        <button id="share-btn" class="secondary-btn" data-i18n="ui.shareLocation" style="margin-left: 10px;">üîó Share</button>
        
        <footer style="text-align: center; margin: 40px 0 20px; padding: 20px 0; border-top: 1px solid #e2e8f0;">
            <p style="font-size: 0.85rem; color: #718096; margin: 0 0 8px 0;">
                <strong>Data Sources:</strong> 
                <a href="https://open-meteo.com/" target="_blank" rel="noopener" style="color: #3182ce; text-decoration: none;">Open-Meteo API</a> ‚Ä¢ 
                <a href="https://ipwho.is/" target="_blank" rel="noopener" style="color: #3182ce; text-decoration: none;">IPWho.is</a>
            </p>
            <p style="font-size: 0.85rem; color: #718096; margin: 8px 0 0 0;">
                <a href="https://github.com/mgifford/risky-weather" target="_blank" rel="noopener" style="color: #3182ce; text-decoration: none;">
                    <svg style="width: 16px; height: 16px; vertical-align: middle; margin-right: 4px;" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                    </svg>
                    View on GitHub
                </a>
            </p>
        </footer>
    </main>

    <!-- Cache Inspector Modal -->
    <div id="cache-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow: auto;">
        <div role="dialog" aria-modal="true" aria-labelledby="cache-modal-title" style="background: white; max-width: 700px; margin: 50px auto; padding: 30px; border-radius: 12px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="cache-modal-title" style="margin: 0; font-size: 1.3rem;">üìã Cache Inspector</h2>
                <button id="close-cache-btn" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úï</button>
            </div>
            <div id="cache-content" style="font-family: monospace; font-size: 0.85rem; line-height: 1.6; color: #2d3748;">
                Loading cache...
            </div>
        </div>
    </div>
    
    <div id="status-log" role="status" aria-live="polite">Status: Init</div>

    <!-- Module Scripts (load in dependency order) -->
    <script src="modules/i18n.js"></script>
    <script src="modules/storage.js"></script>
    <script src="modules/calculations.js"></script>
    <script src="modules/api.js"></script>
    <script src="modules/ui.js"></script>
    <script src="modules/geo.js"></script>
    <script src="modules/education.js"></script>
    <script src="modules/history.js"></script>
    <script src="modules/app.js"></script>

    <!-- Application Entry Point -->
    <script>
        // Initialize application when DOM is ready
        UI.onReset(() => {
            App.reset();
        });

        UI.onRefreshLocation(() => {
            App.refreshLocation();
        });

        UI.onCacheInspector(() => {
            console.log('Cache Inspector opened');
        });

        App.init();
    </script>
</body>
</html>